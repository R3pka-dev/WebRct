<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC Звонок</title>
<style>
body { margin:0; font-family: Arial; background: #121212; color:white; display:flex; height:100vh; }
.sidebar { width:250px; background:#1e1e1e; padding:20px; display:flex; flex-direction:column; gap:15px; }
.sidebar h2 { margin:0; }
.btn { padding:12px; border:none; border-radius:10px; background:#3b82f6; color:white; cursor:pointer; font-size:16px; }
.btn:hover { background:#1d4ed8; }
.input { padding:10px; border-radius:8px; border:none; background:#2a2d36; color:white; font-size:16px; width:100%; }
.container { flex:1; display:flex; flex-direction:column; padding:20px; gap:20px; }
.video-container { display:flex; gap:20px; flex:1; }
.video-box { flex:1; background:#1b1e27; border-radius:14px; padding:15px; display:flex; flex-direction:column; gap:10px; position:relative; }
.video-box h3 { margin:0; }
video { width:100%; height:300px; border-radius:10px; object-fit:cover; background:#333; display:block; }
.status { font-size:14px; color:#a0a0a0; }
.muted-overlay { position:absolute; top:40px; left:10px; background:rgba(255,0,0,0.7); padding:5px 8px; border-radius:6px; font-size:14px; display:none; }
.hangup-btn { background:#ef4444; margin-top:5px; display:none; }
.camera-off-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:#222; display:flex; justify-content:center; align-items:center; font-size:18px; color:#888; display:block; }
.incoming-call { display:none; font-size:14px; color:#facc15; }
</style>
</head>
<body>
<div class="sidebar">
<h2>WebRTC Звонки</h2>
<div>ID: <span id="myId">...</span></div>
<input class="input" id="peerId" placeholder="ID собеседника">
<div class="incoming-call" id="incomingCallDiv">Входящий звонок от: <span id="incomingId">...</span></div>
<button class="btn" id="callBtn">Позвонить</button>
<button class="btn" id="answerBtn" style="display:none">Ответить</button>
<button class="btn" id="toggleAudioBtn" style="display:none">Выкл микрофон</button>
<button class="btn" id="toggleVideoBtn" style="display:none">Выкл камеру</button>
<button class="btn hangup-btn" id="hangupBtn">Отключиться</button>
<div class="status" id="status">Статус: Ожидание</div>
</div>
<div class="container">
<div class="video-container">
<div class="video-box">
<h3>Вы</h3>
<video id="localVideo" autoplay playsinline muted></video>
<div class="camera-off-overlay" id="localCameraOff">Камера выключена</div>
<div class="muted-overlay" id="localMuted">Микрофон выключен</div>
</div>
<div class="video-box">
<h3>Собеседник</h3>
<video id="remoteVideo" autoplay playsinline></video>
<div class="camera-off-overlay" id="remoteCameraOff">Камера выключена</div>
<div class="muted-overlay" id="remoteMuted"></div>
</div>
</div>
</div>
<script>
let ws = new WebSocket('ws://localhost:3000');
let pc;
let localStream;
let myId;
let incomingCallId = null;
const statusDiv = document.getElementById('status');
const peerIdInput = document.getElementById('peerId');
const incomingIdSpan = document.getElementById('incomingId');
const incomingCallDiv = document.getElementById('incomingCallDiv');
const callBtn = document.getElementById('callBtn');
const answerBtn = document.getElementById('answerBtn');
const toggleAudioBtn = document.getElementById('toggleAudioBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const hangupBtn = document.getElementById('hangupBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const localMuted = document.getElementById('localMuted');
const remoteMuted = document.getElementById('remoteMuted');
const localCameraOff = document.getElementById('localCameraOff');
const remoteCameraOff = document.getElementById('remoteCameraOff');

ws.onopen = () => { statusDiv.innerText = 'Статус: Подключено к серверу'; };

ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);
    if(data.type === 'id'){ myId = data.id; document.getElementById('myId').innerText = myId; }
    else if(data.type === 'offer'){
        incomingCallId = data.from;
        incomingIdSpan.innerText = incomingCallId;
        incomingCallDiv.style.display = 'block';
        statusDiv.innerText = 'Вам звонят...';
        answerBtn.style.display = 'block';
        answerBtn.onclick = async () => {
            await initPeer();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type:'answer', to: incomingCallId, answer }));
            answerBtn.style.display = 'none';
            incomingCallDiv.style.display = 'none';
            toggleAudioBtn.style.display = 'inline-block';
            toggleVideoBtn.style.display = 'inline-block';
            hangupBtn.style.display = 'inline-block';
            localMuted.style.display = 'none';
            localCameraOff.style.display = 'flex';
            remoteMuted.style.display = 'none';
            remoteCameraOff.style.display = 'flex';
            toggleAudioBtn.innerText = 'Выкл микрофон';
            toggleVideoBtn.innerText = 'Вкл камеру';
            statusDiv.innerText = 'Статус: Звонок установлен';
        };
    }
    else if(data.type === 'answer'){
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        statusDiv.innerText = 'Статус: Звонок установлен';
        toggleAudioBtn.style.display = 'inline-block';
        toggleVideoBtn.style.display = 'inline-block';
        hangupBtn.style.display = 'inline-block';
        localMuted.style.display = 'none';
        localCameraOff.style.display = 'flex';
        remoteMuted.style.display = 'none';
        remoteCameraOff.style.display = 'flex';
        toggleAudioBtn.innerText = 'Выкл микрофон';
        toggleVideoBtn.innerText = 'Вкл камеру';
    }
    else if(data.type === 'ice'){ if(pc) pc.addIceCandidate(data.candidate); }
    else if(data.type === 'audio'){ remoteMuted.style.display = data.enabled ? 'none' : 'block'; toggleAudioBtn.innerText = data.enabled ? 'Выкл микрофон' : 'Вкл микрофон'; }
    else if(data.type === 'video'){ remoteCameraOff.style.display = data.enabled ? 'none' : 'flex'; toggleVideoBtn.innerText = data.enabled ? 'Выкл камеру' : 'Вкл камеру'; }
};

async function initPeer(){
    pc = new RTCPeerConnection();
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localStream.getVideoTracks().forEach(track => track.enabled = false);
    localVideo.srcObject = localStream;
    localCameraOff.style.display = 'flex';
    localMuted.style.display = 'none';
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
        remoteCameraOff.style.display = 'flex';
        remoteMuted.style.display = 'none';
    };
    pc.onicecandidate = (e) => { if(e.candidate) ws.send(JSON.stringify({ type:'ice', to: incomingCallId || peerIdInput.value, candidate: e.candidate })); };
}

callBtn.onclick = async () => {
    if(!peerIdInput.value){ alert('Введите ID собеседника'); return; }
    statusDiv.innerText = 'Статус: Звоню...';
    await initPeer();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type:'offer', to: peerIdInput.value, offer }));
    hangupBtn.style.display = 'inline-block';
};

toggleAudioBtn.onclick = () => {
    if(localStream){
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !track.enabled;
            localMuted.style.display = track.enabled ? 'none' : 'block';
            toggleAudioBtn.innerText = track.enabled ? 'Выкл микрофон' : 'Вкл микрофон';
            ws.send(JSON.stringify({ type:'audio', to: incomingCallId || peerIdInput.value, enabled: track.enabled }));
        });
    }
};

toggleVideoBtn.onclick = () => {
    if(localStream){
        localStream.getVideoTracks().forEach(track => {
            track.enabled = !track.enabled;
            localCameraOff.style.display = track.enabled ? 'none' : 'flex';
            toggleVideoBtn.innerText = track.enabled ? 'Выкл камеру' : 'Вкл камеру';
            ws.send(JSON.stringify({ type:'video', to: incomingCallId || peerIdInput.value, enabled: track.enabled }));
        });
    }
};

hangupBtn.onclick = () => {
    if(pc){
        pc.close();
        pc = null;
        localCameraOff.style.display = 'flex';
        localMuted.style.display = 'none';
        remoteCameraOff.style.display = 'flex';
        remoteMuted.style.display = 'none';
        statusDiv.innerText = 'Статус: Звонок завершён';
        incomingCallId = null;
        incomingCallDiv.style.display = 'none';
        incomingIdSpan.innerText = '...';
        hangupBtn.style.display = 'none';
        toggleAudioBtn.style.display = 'none';
        toggleVideoBtn.style.display = 'none';
        toggleAudioBtn.innerText = 'Выкл микрофон';
        toggleVideoBtn.innerText = 'Выкл камеру';
    }
};
</script>
</body>
</html>